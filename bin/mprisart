#!/bin/bash
export curw=$(xdotool getactivewindow)
getres () {
  source <(xdotool getwindowgeometry --shell "$@")
  echo $HEIGHT $WIDTH
}
art=$(playerctl metadata mpris:artUrl)
export art=${art##file://}
export title=$(playerctl metadata title)
export artist=$(playerctl metadata artist)
export res=$( (getres $curw) )

show_img () {
  clear
  echo -e "\e[47m"
  w=$(( $2 - 5 ))
  h=$(( $3 - 5 ))
  sleep 0.5 && echo -e \
    "0;1;0;0;$w;$h;;;;;${1}\n4;\n3;" | /usr/lib/w3m/w3mimgdisplay -bg 1
}

show_curr_img () {
  height=${res/\ *}
  width=${res/*\ }
  show_img "$art" $width $height
}

show_curr_img

while sleep 1; do
  aa2=$(playerctl metadata mpris:artUrl)
  t2=$( (getres $curw) )
  aa2=${art##file://}
  ti2=$(playerctl metadata title)
  ar2=$(playerctl metadata artist)

  if [ "$art" != "$aa2" -o "$title" != "$ti2" -o \
      "$artist" != "$ar2" -o "$res" != "$t2" ]; then
    art=$(playerctl metadata mpris:artUrl)
    export art=${art##file://}
    export artist=$( (echo $ar2) )
    export title=$( (echo $ti2) )
    export res=$( (getres $curw) )
    show_curr_img
  else
    read -n 1 -rst 0.5 char
    [ -n "$char" ] && show_curr_img && export char=''
  fi
done

