#!/bin/bash
export curw=$(xdotool getactivewindow)
getres () {
  source <(xdotool getwindowgeometry --shell "$@")
  echo $HEIGHT $WIDTH
}
albumart=$(playerctl metadata mpris:artUrl)
export albumart=${albumart##file://}
export title=$(playerctl metadata title)
export artist=$(playerctl metadata artist)
export termres=$( (getres $curw) )

show_img () {
  clear
  sleep 0.5 && echo -e \
    "0;1;0;0;$2;$3;;;;;${1}\n4;\n3;" | /usr/lib/w3m/w3mimgdisplay -bg 1
}

show_curr_img () {
  height=${termres/\ *}
  width=${termres/*\ }
  show_img "$albumart" $width $height
}

show_curr_img

while sleep 1; do
  aa2=$(playerctl metadata mpris:artUrl)
  t2=$( (getres $curw) )
  aa2=${albumart##file://}
  ti2=$(playerctl metadata title)
  ar2=$(playerctl metadata artist)

  if [ "$albumart" != "$aa2" -o "$title" != "$ti2" -o "$artist" != "$ar2"\
      -o "$termres" != "$t2" ]; then
    albumart=$(playerctl metadata mpris:artUrl)
    export albumart=${albumart##file://}
    export artist=$( (echo $ar2) )
    export title=$( (echo $ti2) )
    export termres=$( (getres $curw) )
    show_curr_img
  else
    read -n 1 -rst 0.5 char
    [ -n "$char" ] && show_curr_img && export char=''
  fi
done

