#!/usr/bin/env coffee
fs = require 'fs'
path = require 'path'

main = (argv) ->
  try
    [input, output] = argv 
    xfpairs = fs.readFileSync path.resolve(input), 'utf8'
      .split '\n'
      .filter RegExp::test.bind /Foreground|Background|Palette/
      .map (ln) => "#{ln.slice 0, ln.indexOf('=')}": ln.slice 1 + ln.indexOf '='
    {ColorForeground: fg, ColorBackground: bg, ColorPalette: colors} = Object.assign ...xfpairs
    final = Object.assign {foreground: fg, background: bg}, colors.split ';'
  catch e
    if not fg? or not bg? or not colors? or e?
      console.log e
      console.error 'Invalid colorscheme file'
      process.exit 1
  finally
    if output isnt '-' and final?
      fs.writeFileSync path.resolve(output), JSON.stringify(final, null, 4)
      console.log "Successfully output to file: '#{output}'"
    else if final?
      console.log JSON.stringify final, null, 4

help = ->
  console.log """
xfce2json - 1.0.0

\t Converts xfce4-terminal color scheme to (termcolors compatible) JSON

USAGE:
\t Output to a file
\t xfce2json <input> [output]

\t Output to terminal(stdout)
\t xfce2json <input> -

\t Dispaly this message
\t xfce2json --help
\t xfce2json -h"""

if module is require.main
  argv = process.argv.slice 2
  if argv.length < 2 and ('-h' in argv or '--help' in argv)
    do help
    process.exit 0
  else if argv.length isnt 2
    console.error 'Not enough arguments'
    console.log 'Pass -h or --help for usage information'
    process.exit 1
  main argv
