// Generated by CoffeeScript 1.12.7
var R, cache, get_property, getenv, histfile, join_path, read_file, ref, sortTime, uniqFile, write_file;

R = require('./lib/ramda.min');

get_property = mp.get_property;

ref = mp.utils, join_path = ref.join_path, read_file = ref.read_file, write_file = ref.write_file, getenv = ref.getenv;

cache = getenv('APPDATA') || getenv('HOME') + '/.cache';

histfile = cache + '/mpv/history.json';

sortTime = R.sort(function(x, y) {
  return y.time - x.time;
});

uniqFile = R.uniqBy(R.prop('file'));

mp.register_event('file-loaded', function() {
  var e, file, log, raw, uniqdLog;
  try {
    raw = read_file(histfile);
  } catch (error) {
    e = error;
    write_file("file://" + histfile, JSON.stringify([], null, 4));
    raw = '[]';
  }
  log = JSON.parse(raw);
  file = join_path(get_property('working-directory'), get_property('path'));
  log.push({
    time: Date.now(),
    file: file
  });
  try {
    uniqdLog = uniqFile(sortTime(log));
    return write_file("file://" + histfile, JSON.stringify(uniqdLog, null, 4));
  } catch (error) {
    e = error;
    return mp.msg.error(e);
  }
});

mp.register_event('idle', function() {
  var e, log, log20, raw;
  try {
    raw = read_file(histfile);
  } catch (error) {
    e = error;
    mp.msg.error("log file doesn't exist");
    write_file("file://" + histfile, JSON.stringify([], null, 4));
    raw = '[]';
  }
  log = uniqFile(sortTime(JSON.parse(raw)));
  log20 = log.slice(0, 20);
  log20.map(function(el) {
    return mp.commandv('loadfile', el.file, 'append-play');
  });
  try {
    return write_file("file://" + histfile, JSON.stringify(log20, null, 4));
  } catch (error) {
    e = error;
    return mp.msg.error(e);
  }
});
